<link rel="stylesheet" th:href="@{/css/product/view.css}">
<link rel="stylesheet" th:href="@{/css/basic.css}">
<header th:replace="layout/main/header.html"></header>
<script th:src="@{/js/main.js}"></script>
<main style="margin-top: 140px; gap: 0">
    <aside th:replace="layout/main/aside.html" style="margin: 0; margin-right: 30px"></aside>
    <div id="wrap">
        <!-- .aside -->
        <main id="main" style="height: auto;">
            <nav id="navi" style="width: 810px">
                <h2 class="sub_tit">상품보기</h2>
                <p class="location">
                    <span>HOME</span>
                    <span>패션·의류·뷰티</span>
                    <span>남성의류</span>
                </p>
            </nav> <!-- #navi-->
            <div class="product_info">
                <img th:src="@{'/file/'+${product.getProdBasicImg()}}" alt="">
                <div class="product_details">
                    <form th:action="@{/prod/cart}" method="post">
                        <table class="tb1">
                            <tr>
                                <td class="td_company">
                                    <span>[[${product.getSellCompany}]]</span>
                                    <span>상품번호 : [[${product.getId}]]</span>
                                    <input type="hidden" value="2" name="prodId">
                                    <span style="
                                        cursor: pointer;
                                        color: red;
                                        border: 1px solid black;
                                        padding: 2px 4px;
                                     " data-id="9" onclick="getCustomerCoupon(event)">쿠폰 발급받기</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="prod_name">
                                    <span>[[${product.getProdName}]]</span> <br>
                                    <img src="https://via.placeholder.com/56x17" alt="별점">
                                    <a href="#">상품평보기</a>
                                </td>
                            </tr>
                            <tr>
                                <td class="price">
                                    <del>[[${#numbers.formatInteger(product.getProdPrice(), 1)}]]원&nbsp;</del>
                                    <span>[[${#numbers.formatInteger(product.getProdDiscount(), 1)}]]%&#8595;</span>
                                    <img src="https://via.placeholder.com/33x17" alt="별점">
                                    <span>무이자 할부 </span>
                                    <img src="https://via.placeholder.com/33x17" alt="별점">
                                    <span>카드 추가 혜택</span> <br>
                                    <span id="finalPrice">[[${#numbers.formatInteger(product.getTotalPrice(), 1)}]]원</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="delivery">
                                    <span>무료배송 </span>
                                    <span id="delivery-date"></span> <br>
                                    <span>본상품은 국내배송만 가능합니다.</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span class="des">원산지 - 상세설명 참조</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <select name="options" class="prodOptions" id="select1">
                                        <option value="">Select an Option</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="display: none">
                                    <select name="options" class="prodOptions" id="select2">
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td style="display: none">
                                    <select name="options" class="prodOptions" id="select3">
                                    </select>
                                    <input type="hidden" id="optionId" name="optionId" value="">
                                </td>
                            </tr>
                            <tr class="count_qty">
                                <td style="float: right">
                                    <span class="qty">수량 </span>
                                    <button type="button" class="decrement">-</button> <!-- 감소 버튼 -->
                                    <input name="quantity" type="number" class="count" value="1" min="1"/>
                                    <button type="button" class="increment">+</button> <!-- 증가 버튼 -->
                                </td>
                            </tr>
                            <tr>
                                <td class="total">
                                    <span>총 상품 금액 </span>
                                    <span id="totalPrice">[[${#numbers.formatInteger(product.getTotalPrice(), 1)}]]원</span>
                                </td>
                            </tr>
                        </table> <!-- .tb1-->
                        <div class="buttons">
                            <button type="submit" class="cart">장바구니</button>
                            <button  type="button" class="btnorder"><a th:href="@{/prod/cart/direct}"> 구매하기</a></button>
                        </div> <!-- .buttons -->
                    </form>
                </div> <!-- .product_details -->
            </div> <!-- .product_info -->
            <h2 class="sub_tit2">상품보기</h2>
            <div class="detail_image">
                <img src="https://via.placeholder.com/784x111" alt="상품 상세 이미지">
            </div> <!-- .detail_image-->
            <h2 class="sub_tit3">
                상품정보 제공고시
                <span>[전자상거래에 관한 상품정보 제공에 관한 고시]항목에 의거 등록된 정보입니다.</span>
            </h2>
            <table class="tb2">
                <colgroup>
                    <col style="width: 40%;">
                    <col style="width: 60%;">
                </colgroup>
                <tr>
                    <th>상품번호</th>
                    <td>10010118412</td>
                </tr>
                <tr>
                    <th>상품상태</th>
                    <td>새상품</td>
                </tr>
                <tr>
                    <th>부가세면세여부</th>
                    <td>과세상품</td>
                </tr>
                <tr>
                    <th>영수증 발행</th>
                    <td>발행가능신용카드전표, 온라인 현금영수증</td>
                </tr>
                <tr>
                    <th>사업자 구분</th>
                    <td>통신판매업자</td>
                </tr>
                <tr>
                    <th>브랜드</th>
                    <td>블루포스</td>
                </tr>
                <tr>
                    <th>원산지</th>
                    <td>국내 생산</td>
                </tr>
            </table> <!-- tb2 -->
            <table class="tb3">
                <colgroup>
                    <col style="width: 40%;">
                    <col style="width: 60%;">
                </colgroup>
                <tr>
                    <th>제조사/수입국</th>
                    <td>상세정보 집적입력</td>
                </tr>
                <tr>
                    <th>제조국</th>
                    <td>상세정보 집적입력</td>
                </tr>
                <tr>
                    <th>취급시 주의사항</th>
                    <td>상세정보 집적입력</td>
                </tr>
                <tr>
                    <th>제조연월</th>
                    <td>상세정보 집적입력</td>
                </tr>
                <tr>
                    <th>품질보증기준</th>
                    <td>상세정보 집적입력</td>
                </tr>
                <tr>
                    <th>A/S 책임자</th>
                    <td>상세정보 집적입력</td>
                </tr>
                <tr>
                    <th>전화번호</th>
                    <td>상세정보 집적입력</td>
                </tr>
            </table> <!-- tb3 -->
            <div class="refund">
                <span>소비자가 전자상거래등에서 소비자 보호에 관한 법률 제 17조 1항 또는 제 3항에 따라 청약철회를 하고
                동법 제 18조 제 1항에 다라 청약철회한 물품을 판매자에게 반환하였음에도 불구하고 결제 대금의 환급이
                3영업일을 넘게 지연된 경우, 소비자는 전자상거래등에서 소비자보호에 관한 법률 제 18조 제 2항 및 동법 시행령 제 21조 2에
                따라 지연일수에 대하여 전상법 시행령으로 정하는 이율을 곱하여 산정한 지연이자("지연배상금")를 신청할 수 있습니다.
                아울러, 교환반품보증 및 결제대금의 환급신청은 [나의 쇼핑정보]에서 하실 수 있으며, 자세한 문의는
                개별 판매자에게 연락하여 주시기 바랍니다.</span>
            </div> <!-- .refund-->
            <h2 class="sub_tit4">상품리뷰</h2>
            <div class="cmt">
                <img src="https://via.placeholder.com/78x20"> <br>
                <span>상품명</span>
                <span>2024-10-13</span>
                <span>nickn*ame </span><br>
                <span>후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~</span>
            </div>
            <div class="page" style="margin: 0 auto;">
                <a href="#">&lt; 이전</a>
                <button>1</button>
                <button>2</button>
                <button>3</button>
                <button>4</button>
                <button>5</button>
                <a href="#">다음 &gt;</a>
            </div> <!-- page -->
        </main> <!-- #main-->
    </div>
    <input type="hidden" th:value="${options}" id="hiddenOption">
</main>
<footer th:replace="layout/main/footer.html"></footer>
<!-- #wrap -->
<script>
    async function getCustomerCoupon(event){
        const submitData = {
            'id' : event.target.dataset.id
        }
        console.log(submitData)
        try {
            const resp = await axios.post("/prod/customer/coupon",submitData,{
                headers : {
                    "Content-Type" : "application/json"
                }
            })
            alert(resp.data)

        } catch (e) {
            alert("로그인이 필요합니다.")
            window.location.href = "/auth/login/view"
        }
    }

    // 요일명을 저장한 배열
    const days = ["일", "월", "화", "수", "목", "금", "토"];

    // 오늘을 기준으로 3일 뒤의 날짜를 계산하는 함수
    function getDeliveryDate() {
        const today = new Date();
        const deliveryDate = new Date(today);

        // 3일 뒤로 설정
        deliveryDate.setDate(today.getDate() + 3);

        // 요일 구하기
        const dayOfWeek = days[deliveryDate.getDay()];

        // 날짜 형식 만들기 (예: "7/8")
        const month = deliveryDate.getMonth() + 1; // getMonth()는 0부터 시작하므로 +1 필요
        const date = deliveryDate.getDate();

        return `(${dayOfWeek}) ${month}/${date} 도착예정`;
    }

    // HTML에 날짜 값 삽입
    document.getElementById("delivery-date").innerText = getDeliveryDate();

    // 수량 증감 버튼 구현하기
    const decrementButton = document.querySelector('.decrement');
    const incrementButton = document.querySelector('.increment');
    const countInput = document.querySelector('.count');

    // 감소 버튼 클릭 시 수량 감소
    decrementButton.addEventListener('click', () => {
        let currentValue = parseInt(countInput.value);
        if (currentValue > parseInt(countInput.min)) {
            countInput.value = currentValue - 1;
            countInput.dispatchEvent(new Event('change')); // change 이벤트 발생
        }
    });

    // 증가 버튼 클릭 시 수량 증가
    incrementButton.addEventListener('click', () => {
        let currentValue = parseInt(countInput.value);
        let maxValue = parseInt(countInput.max); // max 값을 사용하지 않으므로 따로 처리하지 않음

        // max 값이 없거나 현재 값이 max 보다 작다면 증가
        if (!maxValue || currentValue < maxValue) {
            countInput.value = currentValue + 1;
            countInput.dispatchEvent(new Event('change')); // change 이벤트 발생
        }
    });

    window.onload = function () {
        let totalPrice = document.getElementById('totalPrice');

        countInput.addEventListener('change', function () {
            let inNum = countInput.value;
            totalPrice.innerText = inNum * [[${#numbers.formatInteger(product.getTotalPrice(), 1)}]] + "원";
        });

        let option = document.getElementById('hiddenOption').value.trim(); // 데이터 가져오기 및 공백 제거
        option = option.replace(/^\[|\PostProductOptionDTO|\]$/g, '').trim();
        // 데이터 나누기 함수
        function splitDataByParentheses(data) {
            // '),'를 기준으로 문자열을 나누기
            const splitData = data.split("),");

            // 각 요소에 대해 ')'를 복구해주기 (마지막 요소는 ')'가 필요없음)
            const cleanedData = splitData.map((item, index) => {
                // 마지막 요소가 아닌 경우 ')' 추가
                return index !== splitData.length - 1 ? item + ")" : item;
            });

            return cleanedData;
        }

        // 데이터 나누기 실행
        const splitResult = splitDataByParentheses(option);

        // 결과 출력 (콘솔에서 확인)
        console.log(splitResult);

        function extractOptionValue(dataArray, keyName) {
            return dataArray.map(item => {
                // key-value 쌍을 분리
                const keyValuePairs =  item.replace('(', '').replace(')', '') // 괄호 제거
                    .split(',')
                    .map(pair => pair.trim().split('='));

                console.log(keyValuePairs);

                // key-value 배열에서 keyName에 해당하는 값 추출
                const foundPair = keyValuePairs.find(pair => pair[0].trim() === keyName);
                return foundPair ? foundPair[1] : null; // 해당 키의 값이 존재하면 반환, 없으면 null
            }).filter(value => value !== null); // null 값 필터링
        }

        // optionValue 값 추출
        const optionValues = Array.from(new Set(extractOptionValue(splitResult, 'optionValue')));

        console.log("123"+optionValues);
        // select 요소 가져오기
        const selectElement1 = document.getElementById('select1');

        // select에 option 추가하기
        optionValues.forEach(value => {
            const optionElement = document.createElement('option');
            optionElement.textContent = value;
            optionElement.value = value;
            selectElement1.appendChild(optionElement);
        });

        // 결과 확인 (콘솔)
        console.log('Extracted optionValue1:', optionValues);

        selectElement1.addEventListener('change', function () {
            const selectedValue1 = selectElement1.value;

            // optionValue1과 선택된 값이 같은 데이터 필터링
            const filteredData = splitResult.filter(item => {
                const keyValuePairs = item.replace('(', '').replace(')', '') // 괄호 제거
                    .split(',')
                    .map(pair => pair.trim().split('='));
                const foundPair = keyValuePairs.find(pair => pair[0].trim() === 'optionValue');
                return foundPair && foundPair[1] === selectedValue1;
            });

            console.log("543"+filteredData);

            // optionValue2 값 추출 및 중복 제거
            const optionValues2 = Array.from(new Set(extractOptionValue(filteredData, 'optionValue2')));

            console.log("321"+optionValues2);

            // 두 번째 select 요소 가져오기
            const selectElement2 = document.getElementById('select2');

            // 기존 옵션 제거
            selectElement2.innerHTML = '<option value="">Select an Option</option>';

            // optionValue2를 두 번째 select에 추가
            optionValues2.forEach(value => {
                const optionElement = document.createElement('option');
                optionElement.textContent = value;
                optionElement.value = value;
                selectElement2.appendChild(optionElement);
            });
            // 두 번째 select의 부모 td 요소 보이기
            const parentTd = selectElement2.parentNode; // mySelect2의 부모 td를 가져옴
            parentTd.style.display = 'table-cell'; // 또는 'block'으로 설정

            // 두 번째 select 변경 이벤트 추가
            selectElement2.addEventListener('change', function () {
                const selectedValue2 = selectElement2.value;

                const filteredDataForValue3 = filteredData.filter(item => {
                    const keyValuePairs = item.replace('(', '').replace(')', '')
                        .split(',')
                        .map(pair => pair.trim().split('='));
                    const foundPair = keyValuePairs.find(pair => pair[0].trim() === 'optionValue2');
                    return foundPair && foundPair[1] === selectedValue2;
                });

                const optionValues3 = Array.from(new Set(extractKeyValue(filteredDataForValue3, 'optionValue3')));
                const additionalPrices = extractKeyValue(filteredDataForValue3, 'additionalPrice');

                const selectElement3 = document.getElementById('select3');
                selectElement3.innerHTML = '<option value="">Select an Option</option>';

                optionValues3.forEach((value, index) => {
                    const additionalPriceFormatted = Math.floor(additionalPrices[index]); // 소수점 제거
                    const optionElement = document.createElement('option');
                    optionElement.textContent = `${value} (+${additionalPriceFormatted}원)`; // 가격 표시 추가
                    optionElement.value = value;
                    selectElement3.appendChild(optionElement);
                });

                const parentTdForSelect3 = selectElement3.parentNode;
                parentTdForSelect3.style.display = 'table-cell';

                calculateTotalPrice(filteredDataForValue3);
            });
        });

        function extractKeyValue(dataArray, keyName) {
            return dataArray.map(item => {
                const keyValuePairs = item.replace('(', '').replace(')', '')
                    .split(',')
                    .map(pair => pair.trim().split('='));

                const foundPair = keyValuePairs.find(pair => pair[0].trim() === keyName);
                return foundPair ? foundPair[1] : null;
            }).filter(value => value !== null);
        }

        // 가격 계산 함수
        function calculateTotalPrice(filteredData) {
            let additionalPriceSum = 0;

            countInput.addEventListener('change', function () {
                let inNum = countInput.value;

                // 추가 가격 합계 계산
                additionalPriceSum = filteredData.reduce((sum, item) => {
                    const keyValuePairs = item.replace('(', '').replace(')', '')
                        .split(',')
                        .map(pair => pair.trim().split('='));
                    const foundPair = keyValuePairs.find(pair => pair[0].trim() === 'additionalPrice');
                    return sum + (foundPair ? parseFloat(foundPair[1]) : 0);
                }, 0);

                // 총 가격 계산
                let totalPrice1 = inNum * (parseFloat([[${#numbers.formatInteger(product.getTotalPrice(), 1)}]]) + additionalPriceSum);
                totalPrice.innerText = totalPrice1 + "원";
            });

            const ids = filteredData.map(item => {
                const keyValuePairs = item.replace('(', '').replace(')', '')
                    .split(',')
                    .map(pair => pair.trim().split('='));
                const foundPair = keyValuePairs.find(pair => pair[0].trim() === 'id');
                return foundPair ? foundPair[1] : null;
            }).filter(value => value !== null);

            const selectElement3 = document.getElementById('select3');
            selectElement3.addEventListener('change', function () {
                let optionId = document.getElementById('optionId');
                optionId.value = ids;
                console.log("Selected IDs:", optionId); // 선택된 ID 값 출력
                calculateTotalPrice(filteredData);
            });
        }
    };
</script>