<link rel="stylesheet" th:href="@{/css/product/view.css}">
<link rel="stylesheet" th:href="@{/css/basic.css}">
<header th:replace="layout/main/header.html"></header>
<script th:src="@{/js/main.js}"></script>
<main style="margin-top: 230px; gap: 0">
    <aside th:replace="layout/main/aside.html" style="margin: 0; margin-right: 30px"></aside>
    <div id="wrap">
        <!-- .aside -->
        <main id="main" style="height: auto;">
            <nav id="navi" style="width: 810px">
                <h2 class="sub_tit">상품보기</h2>
                <p class="location">
                    <span>[[${location.level1Name}]]</span>
                    <span>[[${location.level2Name}]]</span>
                    <span>[[${location.level3Name}]]</span>
                </p>
            </nav> <!-- #navi-->
            <div class="product_info">
                <img th:src="@{'/file/'+${product.getProdBasicImg()}}" alt="">
                <div class="product_details">
                    <form th:action="@{/prod/cart}" method="POST" id="productForm">
                        <table class="tb1">
                            <tr>
                                <td class="td_company">
                                    <span>[[${product.getSellCompany}]]</span>
                                    <span>상품번호 : [[${product.getId}]]</span>
                                    <input type="hidden" th:value="${product.getId}" name="prodId">
                                    <span style="
                                        cursor: pointer;
                                        color: red;
                                        border: 1px solid black;
                                        padding: 2px 4px;
                                     " th:if="${couponId != 0}" th:data-id="${couponId}" onclick="getCustomerCoupon(event)">쿠폰 발급받기</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="prod_name">
                                    <span>[[${product.getProdName}]]</span> <br>
                                    <img src="https://via.placeholder.com/56x17" alt="별점">
                                    <a href="#prodReview">상품평보기</a>
                                    <a href="#related-products">Ai추천 상품 보기</a>
                                </td>
                            </tr>
                            <tr>
                                <td class="price">
                                    <del>[[${#numbers.formatInteger(product.getProdPrice(), 1)}]]원&nbsp;</del>
                                    <span>[[${#numbers.formatInteger(product.getProdDiscount(), 1)}]]%&#8595;</span>
                                    <img src="https://via.placeholder.com/33x17" alt="별점">
                                    <span th:if="${prodDetail.installmentable}">무이자할부</span>
                                    <span th:unless="${prodDetail.installmentable}">할부(무이자X)</span>
                                    <img src="https://via.placeholder.com/33x17" alt="별점">
                                    <span>카드 추가 혜택</span> <br>
                                    <span id="finalPrice">[[${#numbers.formatInteger(product.getTotalPrice(), 1)}]]원</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="delivery">
                                    <span th:text="'배송비 : ' + ${product.prodDeliver > 0 ? product.prodDeliver + '원' : '무료배송'}"></span>
                                    <span id="delivery-date"></span> <br>
                                    <span th:if="${prodDetail.deliable}">본상품은 해외배송이 가능합니다.</span>
                                    <span th:unless="${prodDetail.deliable}">본상품은 국내배송만 가능합니다</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span class="des">원산지 - [[${prodDetail.origin}]]</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span style="margin-right: 20px;" th:text="${option1s[0].optionName}"></span>
                                    <select onchange="optionIdChanger(event)" name="options" class="prodOptions" id="select1">
                                        <option id="noOption" th:data-id="${option1.optionId}" th:if="${option1.type == 'noOption'}" th:each="option1 : ${option1s}">옵션 없음</option>
                                        <option class="endOption"
                                                th:data-price="${option1.optionPrice}"
                                                th:data-id="${option1.optionId}"
                                                th:if="${option1.type == 'endOption'}"
                                                th:each="option1 : ${option1s}"
                                                th:text="${option1.optionValue} + (${option1.optionPrice} != null ? ' - ' + ${option1.optionPrice} + '원' : '')"></option>
                                        <option class="nextOption" th:data-option="${option1.optionValue}" th:if="${option1.type == 'nextOption'}" th:each="option1 : ${option1s}" th:text="${option1.optionValue}"></option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td id="select2" style="display: none">

                                </td>
                            </tr>
                            <tr>
                                <td style="display: none">
                                    <select name="options" class="prodOptions" id="select3">
                                    </select>
                                    <input type="hidden" id="optionId" name="optionId" value="">
                                    <input type="hidden" id="optionStock" value="">
                                </td>
                            </tr>
                            <tr class="count_qty">
                                <td style="float: right; display: none;" id="qty">
                                    <span class="qty">수량 </span>
                                    <button type="button" class="decrement">-</button> <!-- 감소 버튼 -->
                                    <input name="quantity" type="number" class="count" value="1" min="1"/>
                                    <button type="button" class="increment">+</button> <!-- 증가 버튼 -->
                                </td>
                            </tr>
                            <tr>
                                <td class="total">
                                    <span>총 상품 금액 </span>
                                    <span name="totalPrice" id="totalPrice">[[${#numbers.formatInteger(product.getTotalPrice(), 1)}]]원</span>
                                </td>
                            </tr>
                        </table> <!-- .tb1-->
                        <div class="buttons">
                            <button type="submit" class="cart" onclick="cartBtn()">장바구니</button>
                            <button type="button" class="btnorder"><a> 구매하기</a></button>
                        </div> <!-- .buttons -->
                    </form>
                </div> <!-- .product_details -->
            </div> <!-- .product_info -->
            <div class="view_banner">
                <img src="https://via.placeholder.com/550x64" alt="상품 상세보기 배너">
            </div>
            <h2 class="sub_tit2">상품보기</h2>
            <div class="detail_image">
                <img th:src="@{'/file/'+${prodDetail.getDescription()}}" alt="상품 상세보기 이미지">
            </div> <!-- .detail_image-->
            <h2 class="sub_tit3">
                상품정보 제공고시
                <span>[전자상거래에 관한 상품정보 제공에 관한 고시]항목에 의거 등록된 정보입니다.</span>
            </h2>
            <table class="tb2">
                <colgroup>
                    <col style="width: 40%;">
                    <col style="width: 60%;">
                </colgroup>
                <tr>
                    <th>상품번호</th>
                    <td>[[${prodDetail.productId}]]</td>
                </tr>
                <tr>
                    <th>상품상태</th>
                    <td>[[${prodDetail.stat}]]</td>
                </tr>
                <tr>
                    <th>부가세면세여부</th>
                    <td th:if="${prodDetail.tax}">과세상품</td>
                    <td th:unless="${prodDetail.tax}">비과세상품</td>
                </tr>
                <tr>
                    <th>영수증 발행</th>
                    <td>발행가능신용카드전표, 온라인 현금영수증</td>
                </tr>
                <tr>
                    <th>사업자 구분</th>
                    <td>통신판매업자</td>
                </tr>
                <tr>
                    <th>브랜드</th>
                    <td>[[${product.seller.sellCompany}]]</td>
                </tr>
                <tr>
                    <th>원산지</th>
                    <td>[[${prodDetail.origin}]]</td>
                </tr>
            </table> <!-- tb2 -->
            <table class="tb3">
                <colgroup>
                    <col style="width: 40%;">
                    <col style="width: 60%;">
                </colgroup>
                <tr>
                    <th>제조사/수입국</th>
                    <td>[[${prodDetail.manufacture}]]</td>
                </tr>
                <tr>
                    <th>제조국</th>
                    <td>[[${prodDetail.madein}]]</td>
                </tr>
                <tr>
                    <th>취급시 주의사항</th>
                    <td>[[${prodDetail.caution}]]</td>
                </tr>
                <tr>
                    <th>제조연월</th>
                    <td th:text="${#dates.format(prodDetail.mdate, 'yyyy-MM-dd')}"></td>
                </tr>
                <tr>
                    <th>품질보증기간</th>
                    <td>[[${prodDetail.warranty}]]</td>
                </tr>
                <tr>
                    <th>A/S 책임자</th>
                    <td>[[${product.seller.sellRepresentative}]]</td>
                </tr>
                <tr>
                    <th>전화번호</th>
                    <td>[[${product.seller.sellHp}]]</td>
                </tr>
            </table> <!-- tb3 -->
            <div class="refund">
                <span>소비자가 전자상거래등에서 소비자 보호에 관한 법률 제 17조 1항 또는 제 3항에 따라 청약철회를 하고
                동법 제 18조 제 1항에 다라 청약철회한 물품을 판매자에게 반환하였음에도 불구하고 결제 대금의 환급이
                3영업일을 넘게 지연된 경우, 소비자는 전자상거래등에서 소비자보호에 관한 법률 제 18조 제 2항 및 동법 시행령 제 21조 2에
                따라 지연일수에 대하여 전상법 시행령으로 정하는 이율을 곱하여 산정한 지연이자("지연배상금")를 신청할 수 있습니다.
                아울러, 교환반품보증 및 결제대금의 환급신청은 [나의 쇼핑정보]에서 하실 수 있으며, 자세한 문의는
                개별 판매자에게 연락하여 주시기 바랍니다.</span>
            </div> <!-- .refund-->
            <div id="related-products">
                <div th:each="prod : ${related}" class="relaties">
                    <a th:href="@{/prod/product(prodId=${prod.id})}"><img th:src="@{'/file/'+${prod.getProdBasicImg()}}"></a>
                    <div class="related-descriptions">
                        <p th:text="${prod.prodName}"></p>
                        <p th:text="${prod.prodSummary}"></p>
                    </div>
                </div>
            </div>
            <h2 class="sub_tit4">상품리뷰</h2>
            <div class="cmt" id="prodReview">
                <img src="https://via.placeholder.com/78x20"> <br>
                <span>상품명</span>
                <span>2024-10-13</span>
                <span>nickn*ame </span><br>
                <span>후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~후기 남깁니다~</span>
            </div>
            <div class="page" style="margin: 0 auto;">
                <a href="#">&lt; 이전</a>
                <button>1</button>
                <button>2</button>
                <button>3</button>
                <button>4</button>
                <button>5</button>
                <a href="#">다음 &gt;</a>
            </div> <!-- page -->
        </main> <!-- #main-->
    </div>
    <input type="hidden" th:value="${options}" id="hiddenOption">
</main>
<footer th:replace="layout/main/footer.html"></footer>
<script>
    const noOption = document.getElementById('noOption');
    const totalPrice = document.getElementById('totalPrice')
    const qty = document.getElementById('qty')
    const endOption = document.querySelector('.endOption')
    const endOption2 = document.querySelector('.endOption2')
    const nextOption = document.querySelector('.nextOption')
    const optionId = document.getElementById('optionId')
    let selectedAdditionalPrice = 0;
    let count = 0;
    let basePrice = parseFloat([[${#numbers.formatInteger(product.getTotalPrice(), 1)}]]);
    if(noOption){
        const select1 = document.getElementById('select1')
        const selectedOption = select1.options[select1.selectedIndex];
        optionId.value = selectedOption.dataset.id;
        qty.style.display='block'
    }
    if(endOption){
        qty.style.display='block'
    }

    async function getCustomerCoupon(event){
        const submitData = {
            'id' : event.target.dataset.id
        }
        console.log(submitData)
        try {
            const resp = await axios.post("/prod/customer/coupon",submitData,{
                headers : {
                    "Content-Type" : "application/json"
                }
            })
            alert(resp.data)

        } catch (e) {
            alert("로그인이 필요합니다.")
            window.location.href = "/auth/login/view"
        }
    }

    // 요일명을 저장한 배열
    const days = ["일", "월", "화", "수", "목", "금", "토"];

    // 오늘을 기준으로 3일 뒤의 날짜를 계산하는 함수
    function getDeliveryDate() {
        const today = new Date();
        const deliveryDate = new Date(today);
        const deliveryDate2 = new Date(today);

        // 3일 뒤로 설정

        deliveryDate.setDate(today.getDate() + 3);

        // 요일 구하기
        const dayOfWeek = days[deliveryDate.getDay()];

        // 날짜 형식 만들기 (예: "7/8")
        const month = deliveryDate.getMonth() + 1; // getMonth()는 0부터 시작하므로 +1 필요
        const date = deliveryDate.getDate();
        if([[${prodDetail.deliable}]]){
            return `(${dayOfWeek}) ${month}/${date} 도착예정 (해외배송은 +3~5일)`;
        }else{
            return `(${dayOfWeek}) ${month}/${date} 도착예정`;
        }
    }
    // HTML에 날짜 값 삽입
    document.getElementById("delivery-date").innerText = getDeliveryDate();

    // 수량 증감 버튼 구현하기
    const decrementButton = document.querySelector('.decrement');
    const incrementButton = document.querySelector('.increment');
    const countInput = document.querySelector('.count');

    // 감소 버튼 클릭 시 수량 감소
    decrementButton.addEventListener('click', () => {
        let currentValue = parseInt(countInput.value);
        if (currentValue > parseInt(countInput.min)) {
            countInput.value = currentValue - 1;
            countInput.dispatchEvent(new Event('change')); // change 이벤트 발생
        }
    });

    // 증가 버튼 클릭 시 수량 증가
    incrementButton.addEventListener('click', () => {
        let currentValue = parseInt(countInput.value);
        let maxValue = parseInt(countInput.max); // max 값을 사용하지 않으므로 따로 처리하지 않음

        // max 값이 없거나 현재 값이 max 보다 작다면 증가
        if (!maxValue || currentValue < maxValue) {
            countInput.value = currentValue + 1;
            countInput.dispatchEvent(new Event('change')); // change 이벤트 발생
        }
    });

    countInput.addEventListener('change', function () {
        calculateTotalPrice();
    });

    function calculateTotalPrice() {
        const countInput = document.querySelector('.count');
        let inNum = countInput.value || 0; // 수량을 가져오고 기본값 0 설정
        let totalPriceValue = Number(inNum * basePrice); // 총 가격 계산
        if(selectedAdditionalPrice !== 0){
            totalPriceValue = Number(inNum) * (Number(basePrice)+Number(selectedAdditionalPrice));
        }
        totalPrice.innerText = totalPriceValue + "원"; // 화면에 표시
        totalPrice.value = totalPriceValue;
    }



    async function optionIdChanger(event){
        if(endOption){
            const selectedOption = event.target.options[event.target.selectedIndex];
            if (selectedOption.classList.contains("endOption")) {
                optionId.value = selectedOption.dataset.id;
                if(selectedOption.dataset.price){
                    selectedAdditionalPrice = Number(selectedOption.dataset.price);
                    calculateTotalPrice()
                }
            }
        } else if(nextOption){
            const select2 = document.getElementById('select2')
            const selectedOption = event.target.options[event.target.selectedIndex];
            try {
                const resp = await axios.get("/prod/option2",{
                    headers: {
                        "Content-Type" : "application/json"
                    },
                    params: {
                        "optionValue" : selectedOption.dataset.option,
                        "prodId" : [[${product.id}]]
                    }
                })
                const option2 = resp.data.option2s
                if(option2[0].type==="endOption2"){
                    select2.innerHTML = `
                        <span style="margin-right: 31px;">${option2[0].optionName}</span>
                        <select onclick="optionId2Changer(event)" class="prodOptions">
                    ` + option2.map(v => `
                        <option class="endOption2" data-price="${v.optionPrice}" data-id="${v.optionId}">
                            ${v.optionValue}${v.optionPrice != null ? ' - ' + v.optionPrice + '원' : ''}
                        </option>
                    `).join('') + `
                        </select>
                    `;
                } else {
                    select2.innerHTML = `
                        <span style="margin-right: 31px;">${option2[0].optionName}</span>
                        <select onclick="optionId2Changer(event)" class="prodOptions">
                    ` + option2.map(v => `
                        <option class="nextOption2" data-option="${v.optionValue}">${v.optionValue}</option>
                    `).join('') +`
                        </select>
                    `
                }
                select2.style.display='block'

            } catch (e) {

            }
        }
    }

    async function optionId2Changer(event){
        const selectedOption = event.target.options[event.target.selectedIndex];
        if (selectedOption.classList.contains("endOption2")) {
            optionId.value = selectedOption.dataset.id;
            qty.style.display='block'
            if(selectedOption.dataset.price){
                selectedAdditionalPrice = Number(selectedOption.dataset.price);
                calculateTotalPrice()
            }

        }
    }

    window.onload = function () {
        const select1 = document.getElementById('select1');

        if (endOption) {
            const selectedOption = select1.options[select1.selectedIndex];
            if (selectedOption.classList.contains("endOption")) {
                optionId.value = selectedOption.dataset.id;
                if (selectedOption.dataset.price) {
                    selectedAdditionalPrice = Number(selectedOption.dataset.price);
                    calculateTotalPrice();
                }
            } else {

            }
        }


        const cart= document.querySelector('.cart');
        const productForm = document.querySelector('#productForm');

        cart.addEventListener('click', async function (e){
            e.preventDefault();
            let readPrice = totalPrice.value
            const optionId = document.getElementById('optionId').value

            if(readPrice==null){
                readPrice = basePrice;
            }

            const jsonData = {
                "prodId": productForm.prodId.value,
                "quantity":productForm.quantity.value,
                "totalPrice": readPrice,
                "optionId": optionId
            }
            console.log(jsonData)

            const response = await fetch('/prod/cart',{
                method:'POST',
                headers:{
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            });
            if (!response.ok) throw new Error('주문 상세 정보를 불러오지 못했습니다.');

            data = await response.json();

            console.log(data.status);
            if(data.status=='noAuth'){
                alert('로그인 후 이용해주세요.');
                location.replace('/auth/login/view');
            }else if(data.status=='seller'){
                alert('일반 회원으로 이용해 주세요.')
            }else if(data.status=='customer'){
                confirm('장바구니에 담겼습니다. 장바구니로 이동하시겠습니까?') ? location.replace('/prod/cart') : null;
            }

        })

        const btnorder = document.querySelector('.btnorder');

        btnorder.addEventListener('click',async function (e){
            e.preventDefault();

            let readPrice = totalPrice.value
            const optionId = document.getElementById('optionId').value

            if(readPrice==null){
                readPrice = basePrice;
            }

            const jsonData = {
                "productId": productForm.prodId.value,
                "quantity":productForm.quantity.value,
                "totalPrice": readPrice,
                "optionId": optionId
            }
            console.log(jsonData)

            const response = await fetch('/prod/order/direct',{
                method:'POST',
                headers:{
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            });
            if (!response.ok) throw new Error('주문 상세 정보를 불러오지 못했습니다.');

            data = await response.json();

            console.log(data);
            if(data.status=='noAuth'){
                alert('로그인 후 이용해주세요.');
                location.replace('/auth/login/view');
            }else if(data.status=='seller'){
                alert('일반 회원으로 이용해 주세요.')
            }else if(data.status=='customer'){
                alert('주문서로 이동합니다.');
                location.replace('/prod/order');
            }

        });

    };

</script>
